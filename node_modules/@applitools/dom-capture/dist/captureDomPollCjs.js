/* @applitools/dom-capture@11.6.2 */
"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t=function(){const e=function(e){return function(){function t(e,t=0){const n=e.charCodeAt(t);return n>=55296&&n<56320?1024*(n-55296)+(e.charCodeAt(t+1)-56320)+65536:56320<=n&&n<=57343?-1:n}var n=function(e,n){const o=[];let r=0;for(let s=0;s<e.length;++s){const a=t(e,s);let c=0;a>0&&(c=a<128?1:a<2048?2:a<65536?3:a<2097152?4:a<67108864?5:6),r+c>n?(o.push(s),r=c):r+=c}return o};const o=n,r="WIP",s="SUCCESS",a="SUCCESS_CHUNKED",c="ERROR";var u=function(e,t,n={}){const u=function(e,{chunkByteLength:t=0}={}){if(e){if(e.value){if(t){if(!e.chunks)try{const n=JSON.stringify(e.value);e.chunks=o(n,t),e.chunks.length>0&&(e.from=0,e.value=n)}catch(e){return{status:c,error:e.message}}if(e.from>=0)return{status:a,value:e.value.substring(e.from,e.from=e.chunks.shift()),done:!e.from}}return{status:s,value:e.value}}return e.error?{status:c,error:e.error}:{status:r}}return{status:c,error:"unexpected poll request received - cannot find state of current operation"}}((e=e||{})[t],n);return(u.status===s||u.status===c||u.status===a&&u.done)&&(e[t]=null),u};const i=u;var l={chunkify:n,pollify:function(e,t,n){return o=>function(){return t[n]||(t[n]={},Promise.resolve().then((()=>e.apply(null,arguments))).then((e=>t[n].value=e)).catch((e=>t[n].error=e.message+"\nStack:"+e.stack))),i(t,n,o)}},poll:u,absolutizeUrl:function(e,t){if(function(e){try{return new URL(e),!0}catch(e){return!1}}(e))return e;let n=!0;try{n=e!==decodeURI(e)}catch(e){n=!0}try{const o=new URL(e,t).href;return n?o:decodeURI(o)}catch(t){return n?e:decodeURI(e)}},isInlineFrame:function(e){return e.contentDocument&&e.contentDocument.location&&!/^https?:$/.test(e.contentDocument.location.protocol)},isAccessibleFrame:function(e){try{const t=e.contentDocument;return Boolean(t&&t.defaultView&&t.defaultView.frameElement)}catch(e){return!1}}},d={EYES_NAMESPACE:"__EYES__APPLITOOLS__",DOM_CAPTURE_KEY:"domCaptureResult",NODE_TYPES:{ELEMENT:1,TEXT:3,DOCUMENT_FRAGMENT:11},DEFAULT_STYLE_PROPS:["background-repeat","background-origin","background-position","background-color","background-image","background-size","border-width","border-color","border-style","color","display","font-size","font-weight","font-family","line-height","margin","opacity","overflow","padding","visibility","text-align","position","border-radius","z-index","pointer-events","cursor"],DEFAULT_RECT_PROPS:["width","height","top","left"],DEFAULT_IGNORED_TAG_NAMES:["HEAD","SCRIPT"]};const f=/url\((?!['"]?:)['"]?([^'")]*)['"]?\)/;const{NODE_TYPES:m}=d;function h(e){return Array.prototype.filter.call(e.parentNode.childNodes,(t=>t.tagName===e.tagName)).indexOf(e)+1}var p=function(t){var n=e.implementation.createHTMLDocument(""),o=n.createElement("style");return o.textContent=t,n.body.appendChild(o),o.sheet},g=function(e){const t=Array.from(e.attributes).find((e=>"href"===e.name.toLowerCase()));return t&&t.value},y=function(e){if(e.nodeName&&"LINK"===e.nodeName.toUpperCase()&&e.attributes){const t=new Map(Array.from(e.attributes,(e=>[e.name.toLowerCase(),e.value.toLowerCase()])));return"stylesheet"===t.get("rel")||"style"===t.get("as")&&["preload","prefetch"].includes(t.get("rel"))}return!1};const w=g,E=y;const{absolutizeUrl:C,isInlineFrame:T}=l,b=p,N=g,S=y,{NODE_TYPES:A}=d;const{absolutizeUrl:R,isInlineFrame:$}=l,P=function(e){const t=e?e.match(f):void 0;return t?t[1]:t},_=async function({bgImages:e,timeout:t=5e3,Image:n=window.Image}){return(await Promise.all(Array.from(e).map((e=>{return Promise.race([new Promise((t=>{const o=new n;o.onload=()=>t({url:e,width:o.naturalWidth,height:o.naturalHeight}),o.onerror=()=>t(),o.src=e})),(o=t,new Promise((e=>{setTimeout(e,o)})))]);var o})))).reduce(((e,t)=>(t&&(e[t.url]={width:t.width,height:t.height}),e)),{})},v=function e(t){if(!t.ownerDocument)return"";let n="",o=t,r=t.ownerDocument,s=r.defaultView.frameElement;for(;o!==r&&(!o||o.nodeType!==m.DOCUMENT_FRAGMENT);)n=`${o.tagName}[${h(o)}]/${n}`,o=o.parentNode;return s&&(n=`${e(s)},${n}`),n.replace(/\/$/,"")},U=function({parseCss:e,CSSImportRule:t,absolutizeUrl:n,getCssFromCache:o,unfetchedToken:r}){return function s(a,c){let u,i="";try{const l=e(a);for(const e of Array.from(l.cssRules))if(e instanceof t){const t=n(e.href,c),a=o(t);if(void 0!==a){const{bundledCss:e,unfetchedResources:n}=s(a,t);n&&(u=new Set(n)),i=`${i}${e}`}else u=new Set([t]),i=`\n${r}${t}${r}`}}catch(e){console.log(`error during getBundledCssFromCssText, styleBaseUrl=${c}`,e)}var l,d;return i=`${i}${l=a,d=c,`\n/** ${d} **/\n${l}`}`,{bundledCss:i,unfetchedResources:u}}},D=p,O=function(e,t){try{return["before","after"].reduce(((n,o)=>{const r=e.ownerDocument.defaultView.getComputedStyle(e,`:${o}`);if(r&&"none"!==r.getPropertyValue("content")){(n=n??{})[o]={};for(const e of t)n[o][e]=r.getPropertyValue(e)}return n}),void 0)}catch(e){return}},k=function(e,{fetchTimeLimit:t}={}){return async function(n){const o=new AbortController,r=[e(n,{cache:"force-cache",signal:o.signal}).then((e=>{if(e.ok)return e.text();console.log("/failed to fetch (status "+e.status+") css from: "+n+"/")})).catch((e=>{console.log("/failed to fetch (error "+e.toString()+") css from: "+n+"/")}))];return Number.isNaN(Number(t))||r.push(new Promise((e=>setTimeout(e,t))).then((()=>o.abort()))),Promise.race(r)}},F=function({getCssFromCache:e,absolutizeUrl:t}){return function(n,o){let r,s,a;if(n&&function(e){return e.nodeName&&"STYLE"===e.nodeName.toUpperCase()}(n))r=Array.from(n.childNodes).map((e=>e.nodeValue)).join(""),s=o;else if(n&&E(n)){const c=w(n);c?function(e){return e&&e.startsWith("data:")}(c)?(s=o,r=c.match(/,(.+)/)[1]):(s=t(c,o),r=e(s)):r="",a=void 0===r}return{cssText:r,styleBaseUrl:s,isUnfetched:a}}},I=function({extractCssFromNode:e,getBundledCssFromCssText:t,unfetchedToken:n}){return function(o,r){const{styleBaseUrl:s,cssText:a,isUnfetched:c}=e(o,r);let u,i="";if(a){const{bundledCss:e,unfetchedResources:n}=t(a,s);i+=e,u=new Set(n)}else c&&(i+=`${n}${s}${n}`,u=new Set([s]));return{bundledCss:i,unfetchedResources:u}}},L=function(t){return async function(n=e){const o={},r=Date.now(),s=[];return function e(n,o,r,s){function c(e){if(s.push(async function(e,n,o){let r,s;e&&S(e)&&(s=C(N(e),n),r=await t(s),void 0!==r&&(o[s]=r)),r&&await a(r,s,o)}(e,o,r)),e.nodeType===A.ELEMENT)return"IFRAME"===e.tagName.toUpperCase()?i(e):u(e)}function u(e){Array.prototype.map.call(e.childNodes,c)}function i(t){if(u(t),t.contentDocument)try{const n=T(t)?t.baseURI:t.contentDocument.location.href;e(t.contentDocument,n,r,s)}catch(t){console.log(t)}}c(n.documentElement)}(n,n.location.href,o,s),await Promise.all(s),console.log("[prefetchAllCss]",Date.now()-r),function(e){return o[e]};async function a(e,n,o){try{const r=b(e),s=[];for(const e of Array.from(r.cssRules))e instanceof CSSImportRule&&s.push((async()=>{const r=C(e.href,n),s=await t(r);o[r]=s,void 0!==s&&await a(s,r,o)})());await Promise.all(s)}catch(e){console.log(`error during fetchBundledCss, resourceUrl=${n}`,e)}}}},{NODE_TYPES:x,DEFAULT_STYLE_PROPS:M,DEFAULT_RECT_PROPS:V,DEFAULT_IGNORED_TAG_NAMES:B}=d;const{pollify:Y}=l,{EYES_NAMESPACE:z,DOM_CAPTURE_KEY:j}=d,G=async function({doc:t=e,styleProps:n=M,rectProps:o=V,elementProps:r=[],ignoredTagNames:s=B,capturePseudo:a=!1,addStats:c=!1,fetchTimeLimit:u=3e4}={}){
/* MARKER FOR TEST - DO NOT DELETE */
arguments[1]&&(t=arguments[1]),arguments[2]&&(c=arguments[2]),arguments[3]&&(u=arguments[3]),!0===n&&(n=[...getComputedStyle(t.body)]);const i={total:{},prefetchCss:{},doCaptureDoc:{},waitForImages:{}};function l(e){e.startTime=Date.now()}function d(e){e.endTime=Date.now(),e.elapsedTime=e.endTime-e.startTime}const f=[];l(i.total);const m=new Set,h=[],p="@@@@@",g="#####",y="-----";l(i.prefetchCss);const w=L(k(fetch,{fetchTimeLimit:u})),E=await w(t);d(i.prefetchCss);const C=U({parseCss:D,CSSImportRule:CSSImportRule,getCssFromCache:E,absolutizeUrl:R,unfetchedToken:g}),T=F({getCssFromCache:E,absolutizeUrl:R}),b=I({extractCssFromNode:T,getBundledCssFromCssText:C,unfetchedToken:g});l(i.doCaptureDoc);const N=function c(u,i=u.location&&u.location.href){const l=new Set;let d="";const g=y(u.documentElement||u);return g.css=d,f.push(_({bgImages:l}).then((e=>g.images=e))),g;function y(t){if(t.hasAttribute&&t.hasAttribute("data-applitools-skip"))return null;const{bundledCss:n,unfetchedResources:r}=b(t,i);if(d+=n,r)for(const e of r)m.add(e);switch(t.nodeType){case x.TEXT:return function(t){const n=e.createRange();n.selectNode(t);const r=n.getClientRects();return{tagName:"#text",text:t.textContent,rects:r&&r.length&&o.length?Array.from(r).map((e=>{const t={};for(const n of o)t[n]=e[n];return t})):void 0}}(t);case x.ELEMENT:return"IFRAME"===t.tagName.toUpperCase()?function(e){const t=w(e);let n;try{n=e.contentDocument}catch(e){return o(),t}try{n?t.childNodes=[c(n,$(e)?e.baseURI:n.location.href)]:o()}catch(e){console.log("error in iframeToJSON",e)}return t;function o(){const n=v(e);h.push(n),t.childNodes=[`${p}${n}${p}`]}}(t):w(t);case x.DOCUMENT_FRAGMENT:return{childNodes:Array.prototype.map.call(t.childNodes,y).filter(Boolean)};default:return null}}function w(e){const u=Array.prototype.map.call(e.childNodes,y).filter(Boolean),d=e.shadowRoot&&c(e.shadowRoot,i),f=e.tagName.toUpperCase();if(s.indexOf(f)>-1)return null;const m=t.defaultView.getComputedStyle(e),h=e.getBoundingClientRect(),p={};for(const e of n)p[e]=m.getPropertyValue(e);!p["border-width"]&&n.includes("border-width")&&(p["border-width"]=`${m.getPropertyValue("border-top-width")} ${m.getPropertyValue("border-right-width")} ${m.getPropertyValue("border-bottom-width")} ${m.getPropertyValue("border-left-width")}`);const g={};for(const e of o)g[e]=h[e];const w=Array.from(e.attributes).map((e=>({key:e.name,value:e.value}))).reduce(((e,t)=>(e[t.key]=t.value,e)),{});"INPUT"!==f&&"TEXTAREA"!==f||!e.value||(w.value&&console.log(`[captureFrame] Overriding element attributes value from ${w.value} to ${e.value}`),w.value=e.value);const E=P(m.getPropertyValue("background-image"));E&&l.add(E);const C=O(e,n),T=a?C:void 0;C&&(w["data-applitools-has-pseudo"]=Object.keys(C).join("_and_"));const b={};for(const t of r)b[t]=e[t];const N={tagName:f,style:j(p),rect:j(g),attributes:j(w),properties:j(b),childNodes:u,pseudo:T};return d&&(N.shadowRoot=d),N}}(t);d(i.doCaptureDoc),l(i.waitForImages),await Promise.all(f),d(i.waitForImages),N.version="1.3.0",N.scriptVersion="11.6.2";const S=h.length?`${h.join("\n")}\n`:"",A=m.size?`${Array.from(m).join("\n")}\n`:"",Y=JSON.stringify({separator:y,cssStartToken:g,cssEndToken:g,iframeStartToken:`"${p}`,iframeEndToken:`${p}"`});d(i.total);const z=`${Y}\n${A}${y}\n${S}${y}\n${JSON.stringify(N)}${c?`\n${y}\n${JSON.stringify(i)}`:""}`;return console.log("[captureFrame]",JSON.stringify(i)),z;function j(e){return Object.keys(e).length?e:void 0}};window[z]=window[z]||{};const J=Y(G,window[z],j);return function(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}((function(e){return JSON.stringify(J(e)(e))}))}()};let t=!0;try{let n=document.head.querySelector("[data-applitools-sandbox]");n||(n=document.createElement("iframe"),n.setAttribute("data-applitools-sandbox",""),n.setAttribute("data-applitools-skip",""),document.head.appendChild(n));const o=window.crypto.getRandomValues(new Uint32Array(1))[0],r=n.contentDocument.createElement("script");r.textContent=`window['ctor-${o}'] = ${e.toString()};`,n.contentDocument.head.appendChild(r);const s=n.contentWindow[`ctor-${o}`];if("function"!=typeof s)throw new Error("Sandbox failed to extract function");return t=!1,s(document).apply(null,arguments)}catch(n){try{return e(document).apply(null,arguments)}catch(e){throw t?e:n}}},n=e(t);module.exports=n;
